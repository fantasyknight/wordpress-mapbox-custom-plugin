window.MapBox={},window.$=jQuery,MapBox.initialize=function(){mapboxgl.accessToken=$("#map-box-key").val(),MapBox.map=new mapboxgl.Map({container:"log-map",style:"mapbox://styles/mapbox/streets-v12",center:[13.405,52.52],zoom:13}),MapBox.apiURL=$("#api-url").val(),MapBox.infoPopup=new mapboxgl.Popup({closeButton:!1,closeOnClick:!1}),MapBox.tags=[],MapBox.userId=$("#user-id").val(),MapBox.isLoggedIn=MapBox.userId>0,MapBox.markers=[],MapBox.searhResults=[],MapBox.isPopupOpened=!1,MapBox.searchList=[],MapBox.updateDataByTag(),$("#only-mine").change(MapBox.updateMarkers),$("#search-input").on("input",MapBox.searchByName),$(document).click((function(){$("#search-list").attr("style","display: none")})),$("#search-input").click((function(e){e.stopPropagation(),MapBox.searchList.length>0&&""!==$("#search-input").val()&&$("#search-list").attr("style","display: block")})),MapBox.isLoggedIn&&MapBox.map.on("click",MapBox.addMarkerModal)},MapBox.addMarkerModal=function(e){MapBox.isPopupOpened||(MapBox.coordinates=e.lngLat,MapBox.settingPopup=new mapboxgl.Popup({closeOnClick:!1,closeOnMove:!0}).setLngLat(MapBox.coordinates).setHTML($("#marker-setting").html()).addTo(MapBox.map),MapBox.isPopupOpened=!0,$(MapBox.settingPopup._content.querySelector(".chosen-select")).chosen(),$(MapBox.settingPopup._content.querySelector(".btn-success")).click(MapBox.addMarker),$(MapBox.settingPopup._content.querySelector(".btn-danger")).click((function(){MapBox.settingPopup.remove(),MapBox.isPopupOpened=!1})),MapBox.isLoggedIn&&MapBox.settingPopup.on("close",(()=>{MapBox.isPopupOpened=!1})))},MapBox.addMarker=function(){let e=$(MapBox.settingPopup._content.querySelector(".marker-name")).val(),a=$(MapBox.settingPopup._content.querySelector(".marker-tag")).val(),o=$(MapBox.settingPopup._content.querySelector(".new-tag")).val();if(""!==e&&(a.length>0||""!==o)){var t=new mapboxgl.Marker({color:"red"});t.setLngLat(MapBox.coordinates).addTo(MapBox.map),MapBox.markers.push(t),MapBox.isPopupOpened=!1,MapBox.settingPopup.remove();const e=t.getElement();MapBox.saveMarkerSettings(e)}},MapBox.saveMarkerSettings=function(e){let a={user_id:MapBox.userId,name:$(MapBox.settingPopup._content.querySelector(".marker-name")).val(),tag:$(MapBox.settingPopup._content.querySelector(".marker-tag")).val(),new_tag:$(MapBox.settingPopup._content.querySelector(".new-tag")).val(),lat:MapBox.settingPopup._lngLat.lat,lng:MapBox.settingPopup._lngLat.lng};$.ajax({type:"post",url:MapBox.apiURL,data:{...a},success:function(e){MapBox.updateDataByTag(!1)}}),e.addEventListener("mouseenter",(()=>{MapBox.showPopup(a)})),e.addEventListener("mouseleave",MapBox.removePopup)},MapBox.updateDataByTag=function(e=!0){$.ajax({url:MapBox.apiURL,data:{tag:MapBox.tags,user_id:MapBox.userId},success:function(a){console.log("Results are",a),MapBox.myMakers=a.my_markers,MapBox.otherMarkers=a.other_markers;var o="<option selected>"+a.tags[0].name+"</option>";for(let e=1;e<a.tags.length;e++)o=o+"<option>"+a.tags[e].name+"</option>";$("#marker-setting select").html(o);var t="";for(let e=0;e<a.tags.length;e++){let o=a.tags[e];t+=`<div class='tag-item form-check'>\n                    <input class='form-check-input' type='checkbox' value='' ${MapBox.tags.includes(o.slug)?"checked":""} id='${a.tags[e].slug}'>\n                    <label class='form-check-label' for='${o.slug}' title='${o.name} ( ${o.count} )'>\n                    ${o.name} ( ${o.count} )\n                    </label>\n                </div>`}$("#sidebar-tags").html(t),$("#sidebar-tags .form-check-input").change((function(e){let a=$(this).attr("id");if(e.currentTarget.checked)MapBox.tags.push(a);else{let e=MapBox.tags.indexOf(a);MapBox.tags.splice(e,1)}MapBox.updateDataByTag()})),e&&MapBox.updateMarkers()}})},MapBox.searchByName=function(){let e=$("#search-input").val(),a=!1;e.length>0?$.ajax({url:MapBox.apiURL,data:{user_id:MapBox.userId,search:e},success:function(e){let o="";MapBox.searchList=[],e.my_markers.length+e.other_markers.length>0&&(a=!0),[...e.my_markers,...e.other_markers].forEach((e=>{MapBox.searchList.push(e),o+=`<li lng='${e.lng}' lat='${e.lat}'>${e.name}</li>`})),$("#search-list").html(o),$("#search-list").attr("style",a?"display: block":"display: none"),$("#search-list li").click(MapBox.moveTo)}}):$("#search-list").attr("style","display: none")},MapBox.updateMarkers=function(){MapBox.markers.forEach((e=>e.remove())),MapBox.markers=[],MapBox.myMakers.map((e=>{let a=new mapboxgl.Marker({color:"red"}).setLngLat([e.lng,e.lat]).addTo(MapBox.map);const o=a.getElement();o.addEventListener("mouseenter",(()=>{MapBox.showPopup(e)})),o.addEventListener("mouseleave",MapBox.removePopup),MapBox.markers.push(a)})),$("#only-mine")[0].checked||MapBox.otherMarkers.map((e=>{let a=new mapboxgl.Marker({color:"black"}).setLngLat([e.lng,e.lat]).addTo(MapBox.map);const o=a.getElement();o.addEventListener("mouseenter",(()=>{MapBox.showPopup(e)})),o.addEventListener("mouseleave",MapBox.removePopup),MapBox.markers.push(a)}))},MapBox.moveTo=function(e){$("#search-input").val($(e.target).html()),lng=parseFloat($(e.target).attr("lng")),lat=parseFloat($(e.target).attr("lat")),MapBox.map.flyTo({center:[lng,lat],essential:!0})},MapBox.showPopup=function(e){$("#marker-name-info").html(e.name),$("#marker-tag-info").html(e.tag.toString()),$("#marker-lng-info").html(parseFloat(e.lng).toFixed(2)),$("#marker-lat-info").html(parseFloat(e.lat).toFixed(2)),MapBox.popup=new mapboxgl.Popup({closeButton:!1}).setLngLat([e.lng,e.lat]).setHTML($("#marker-info").html()).addTo(MapBox.map)},MapBox.removePopup=function(){MapBox.popup.remove()},$(document).ready((function(){MapBox.initialize()}));