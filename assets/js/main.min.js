window.MapBox={},window.$=jQuery,MapBox.initialize=function(){mapboxgl.accessToken=$("#map-box-key").val(),MapBox.map=new mapboxgl.Map({container:"log-map",style:"mapbox://styles/mapbox/streets-v12",center:[13.405,52.52],zoom:13}),MapBox.apiURL=$("#api-url").val(),MapBox.infoPopup=new mapboxgl.Popup({closeButton:!1,closeOnClick:!1}),MapBox.tags=[],MapBox.userId=$("#user-id").val(),MapBox.isLoggedIn=MapBox.userId>0,MapBox.markers=[],MapBox.searhResults=[],MapBox.isPopupOpened=!1,MapBox.searchList=[],MapBox.updateDataByTag(),$("#only-mine").change(MapBox.updateMarkers),$("#search-input").on("input",MapBox.searchByName),$(document).click((function(){$("#search-list").attr("style","display: none")})),$("#search-input").click((function(a){a.stopPropagation(),MapBox.searchList.length>0&&""!==$("#search-input").val()&&$("#search-list").attr("style","display: block")})),MapBox.isLoggedIn&&MapBox.map.on("click",MapBox.addMarkerModal)},MapBox.addMarkerModal=function(a){MapBox.isPopupOpened||(MapBox.coordinates=a.lngLat,MapBox.settingPopup=new mapboxgl.Popup({closeOnClick:!1,closeOnMove:!0}).setLngLat(MapBox.coordinates).setHTML($("#marker-setting").html()).addTo(MapBox.map),MapBox.isPopupOpened=!0,$(MapBox.settingPopup._content.querySelector(".chosen-select")).chosen(),$(MapBox.settingPopup._content.querySelector(".btn-success")).click(MapBox.addMarker),$(MapBox.settingPopup._content.querySelector(".btn-danger")).click((function(){MapBox.settingPopup.remove(),MapBox.isPopupOpened=!1})),MapBox.isLoggedIn&&MapBox.settingPopup.on("close",(()=>{MapBox.isPopupOpened=!1})))},MapBox.addMarker=function(){var a=new mapboxgl.Marker({color:"red"});a.setLngLat(MapBox.coordinates).addTo(MapBox.map),MapBox.markers.push(a),MapBox.isPopupOpened=!1,MapBox.settingPopup.remove();const e=a.getElement();MapBox.saveMarkerSettings(e)},MapBox.saveMarkerSettings=function(a){let e={user_id:MapBox.userId,name:$(MapBox.settingPopup._content.querySelector(".marker-name")).val(),tag:$(MapBox.settingPopup._content.querySelector(".marker-tag")).val(),new_tag:$(MapBox.settingPopup._content.querySelector(".new-tag")).val(),lat:MapBox.settingPopup._lngLat.lat,lng:MapBox.settingPopup._lngLat.lng};$.ajax({type:"post",url:MapBox.apiURL,data:{...e},success:function(a){MapBox.updateDataByTag(!1)}}),a.addEventListener("mouseenter",(()=>{MapBox.showPopup(e)})),a.addEventListener("mouseleave",MapBox.removePopup)},MapBox.updateDataByTag=function(a=!0){$.ajax({url:MapBox.apiURL,data:{tag:MapBox.tags,user_id:MapBox.userId},success:function(e){MapBox.myMakers=e.my_markers,MapBox.otherMarkers=e.other_markers;var o="<option selected>"+e.tags[0].name+"</option>";for(let a=1;a<e.tags.length;a++)o=o+"<option>"+e.tags[a].name+"</option>";$("#marker-setting select").html(o);var t="";for(let a=0;a<e.tags.length;a++){let o=e.tags[a];t+=`<div class="tag-item form-check">\n                    <input class="form-check-input" type="checkbox" value="" ${MapBox.tags.includes(o.slug)?"checked":""} id="${e.tags[a].slug}">\n                    <label class="form-check-label" for="${o.slug}" title="${o.name} ( ${o.count} )">\n                    ${o.name} ( ${o.count} )\n                    </label>\n                </div>`}$("#sidebar-tags").html(t),$("#sidebar-tags .form-check-input").change((function(a){let e=$(this).attr("id");if(a.currentTarget.checked)MapBox.tags.push(e);else{let a=MapBox.tags.indexOf(e);MapBox.tags.splice(a,1)}MapBox.updateDataByTag()})),a&&MapBox.updateMarkers()}})},MapBox.searchByName=function(){let a=$("#search-input").val(),e=!1;a.length>0?$.ajax({url:MapBox.apiURL,data:{user_id:MapBox.userId,search:a},success:function(a){let o="";MapBox.searchList=[],a.my_markers.length+a.other_markers.length>0&&(e=!0),[...a.my_markers,...a.other_markers].forEach((a=>{MapBox.searchList.push(a),o+=`<li lng="${a.lng}" lat="${a.lat}">${a.name}</li>`})),$("#search-list").html(o),$("#search-list").attr("style",e?"display: block":"display: none"),$("#search-list li").click(MapBox.moveTo)}}):$("#search-list").attr("style","display: none")},MapBox.updateMarkers=function(){MapBox.markers.forEach((a=>a.remove())),MapBox.markers=[],MapBox.myMakers.map((a=>{let e=new mapboxgl.Marker({color:"red"}).setLngLat([a.lng,a.lat]).addTo(MapBox.map);const o=e.getElement();o.addEventListener("mouseenter",(()=>{MapBox.showPopup(a)})),o.addEventListener("mouseleave",MapBox.removePopup),MapBox.markers.push(e)})),$("#only-mine")[0].checked||MapBox.otherMarkers.map((a=>{let e=new mapboxgl.Marker({color:"black"}).setLngLat([a.lng,a.lat]).addTo(MapBox.map);const o=e.getElement();o.addEventListener("mouseenter",(()=>{MapBox.showPopup(a)})),o.addEventListener("mouseleave",MapBox.removePopup),MapBox.markers.push(e)}))},MapBox.moveTo=function(a){$("#search-input").val($(a.target).html()),lng=parseFloat($(a.target).attr("lng")),lat=parseFloat($(a.target).attr("lat")),MapBox.map.flyTo({center:[lng,lat],essential:!0})},MapBox.showPopup=function(a){$("#marker-name-info").html(a.name),$("#marker-tag-info").html(a.tag),$("#marker-lng-info").html(parseFloat(a.lng).toFixed(2)),$("#marker-lat-info").html(parseFloat(a.lat).toFixed(2)),MapBox.popup=new mapboxgl.Popup({closeButton:!1}).setLngLat([a.lng,a.lat]).setHTML($("#marker-info").html()).addTo(MapBox.map)},MapBox.removePopup=function(){MapBox.popup.remove()},$(document).ready((function(){MapBox.initialize()}));